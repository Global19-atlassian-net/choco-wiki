# Setting up QDE to be Accessible over the Internet

With an unprecedented amount of employees working from home, there is a much greater demand to serve their software lifecycle needs remotely. Thus, many organizations would like the option to make the Chocolatey Quick Deployment Environment (QDE) Internet-accessible. This document walks you through some options you will need to consider, if you choose this route.

<!-- TOC depthFrom:2 -->

- [Firewall Considerations](#firewall-considerations)
- [SSL Certificate Setup](#ssl-certificate-setup)
- [Nexus Setup](#nexus-setup)
- [CCM Setup](#ccm-setup)
- [Adjusting Scripts for Client Setup](#adjusting-scripts-for-client-setup)
- [Jenkins?](#jenkins)

<!-- /TOC -->


## Firewall Considerations

When we talk about making QDE Internet-accessible, we are referring to exposing at least certain application ports on QDE via your VM/Organizational firewall; namely:
* **Chocolatey Central Management (CCM) Service (24020)**: This port is used for communication between Chocolatey Agent on your endpoint and the CCM server.
* **Sonatype Nexus repository (8443)**: This is the port on which endpoints will connect to your Nexus repository (over HTTPS), in order to download packages for install/upgrade.

There are, of course, additional applications and ports on the QDE server, but it is not required to have these accessible externally. The CCM Webs dashboard is on port 443, and Jenkins is on port 8080. You can access these by remoting to the server itself, or opening their ports up in your internal network only.

Further details on firewall changes can be found on the [[QDE Firewall Setup|QuickDeploymentFirewallChanges]] page.


## SSL Certificate Setup

It is highly recommended that the default certificates generated for you are not used, but rather new ones generated. This is required for the following scenarios:

* If you want to expose QDE to the internet, so clients can connect from outside your network.
* If you change the hostname of this server.
* If you add QDE to a domain.
* If you would like to use your own SSL/TLS certificates.

This script will generate new SSL certificates for all services, move them to the appropriate locations, and configure the services to use them.

> :memo: **NOTE**: Please run the below from an administrative PowerShell session.

```powershell
Set-ExecutionPolicy Bypass -Scope Process -Force; . C:\choco-setup\files\New-SslCertificates.ps1
```

> :warning: **WARNINGS**
>
> Please take note of the following warnings here:
> * This script will seemingly prompt for input, and have other strange output.
> This is due to poor Java tooling and console output which cannot be suppressed.
> Just let things happen, as things are working as expected.
> * If you provide your own certificate, it needs to include the private key to allow for export. Nexus requires this.
> * **Timezones** and time synchronization is critical when generating SSL Certificates. You'll wan to ensure all hosts are utili. Otherwise there is a potential edge case you could generate an SSL Certificate that is not yet valid.
> * If you are planning to **rename** the QDE VM to a hostname other than `chocoserver`, this step needs to be completed FIRST prior to ANYTHING that is done on the QDE box. It is strongly recommended **NOT** to rename unless you absolutely need to. The most important reason has to do with how a client installs from QDE - it must learn to trust the QDE certificate. Once renamed, the easy option that's provided for you goes away and you will need to provide a hosted solution with an already trusted certificate.
> * You can provide your own certificate that is already trusted on machines as part of the [[SSL/TLS Setup|QuickDeploymentSslSetup]]. Your other option is to host the script to trust the certificate with an already trusted certificate. You will find a template that you will need to edit at `c:\choco_setup_files` (in the QDE) named `Import-ChocoServerCertificate.ps1`.

3 Scenarios for SSL Certificates:
Self-Signed certs generated by New-SslCertificates.ps1 script
Domain certificate for FQDN of server
Web SSL certificate purchased from an external CA (different FQDN)


## Nexus Setup

By default, you can check a box to allow “Anonymous” access when initially setting up Nexus. This is good initially, but will need to be changed if planning to expose it over the Internet.

As well, exposing Nexus to the Web means having to secure all the different parts of it:
SSL Certificate for HTTPS URI
Create a Role for ChocoUser Access
Create a ChocoUser and add to above role
Place credential in all “choco source add” commands
Allow passing of the credential as variable/parameter to all client setup scripts

Both the following scripts on the “choco-install” raw repository will need to be modified:
ChocolateyInstall.ps1
ClientSetup.ps1

See below.

## CCM Setup

Considerations:
Upgrade CCM packages to 0.3.0 if planning to use Deployments
https://chocolatey.org/docs/central-management-setup-client#config-settings
* centralManagementServiceCommunicationSaltAdditivePassword
* centralManagementClientCommunicationSaltAdditivePassword

## Adjusting Scripts for Client Setup

Both the following scripts on the “choco-install” raw repository will need to be modified:
ChocolateyInstall.ps1
ClientSetup.ps1

Considerations:
User credential when connecting to other repo’s will need to be passed
Salt additive for server and client will need to be added, if checking into CCM
Both the above will need to be turned into variables/parameters that can be passed at runtime, so that the credentials themselves don’t need to live in these files
CCM Deployments opt-in will need to be done, if CCM has been upgraded

## Jenkins?

Jenkins is currently accessible over HTTP. Do we tell users to just use this only on the QDE server itself, and not expose it to the web at all? Is there a security concern with this?
